<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ù‡Ø§ÙŠØ¨Ù€Ø±ÙŠÙˆÙ† Ø£Ù„ØªÙŠÙ…ÙŠØª | ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>

    <!-- Ø®Ø·ÙˆØ· ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #000000;
            --glass: rgba(28, 28, 30, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #0A84FF;
            --danger: #FF453A;
            --success: #30D158;
            --text-main: #FFFFFF;
            --text-sub: #98989D;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background-color: var(--bg-deep); color: var(--text-main); font-family: 'Tajawal', sans-serif; overflow-x: hidden; min-height: 100vh; }
        #cosmos { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1c1c1e 0%, #000000 100%); }

        /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(20px); transition: opacity 0.5s;
        }
        .login-box {
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 40px; border-radius: 20px; width: 350px; text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .login-title { font-size: 1.5rem; font-weight: 900; margin-bottom: 20px; color: white; }
        .login-input {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            padding: 12px; border-radius: 10px; color: white; font-family: 'Tajawal';
            margin-bottom: 15px; outline: none; box-sizing: border-box;
        }
        .login-input:focus { border-color: var(--primary); }
        .auth-actions { display: flex; gap: 10px; align-items: center; }
        .btn-login {
            flex: 2; padding: 12px; background: var(--primary); color: white; border: none;
            border-radius: 10px; cursor: pointer; font-weight: bold; font-family: 'Tajawal';
        }
        .btn-bio {
            flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);
            border-radius: 10px; cursor: pointer; color: var(--primary); font-size: 1.2rem;
        }
        .btn-bio:hover { background: rgba(10,132,255,0.1); border-color: var(--primary); }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .layout { max-width: 1300px; margin: 0 auto; padding: 40px 20px; filter: blur(10px); opacity: 0; transition: 1s; display: none; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding: 25px 40px; background: var(--glass); backdrop-filter: blur(25px); border-radius: 24px; border: 1px solid var(--glass-border); }
        .brand h1 { font-weight: 900; font-size: 2rem; margin: 0; }
        .brand span { color: var(--primary); font-size: 0.8em; }
        .live-dot { height: 12px; width: 12px; background-color: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 15px var(--success); animation: pulse 2s infinite; margin-right: 10px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .panel { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 25px; transition: 0.3s; position: relative; overflow: hidden; }
        .panel-label { font-size: 0.9rem; color: var(--text-sub); display: block; margin-bottom: 10px; }
        .panel-value { font-size: 2rem; font-weight: 800; margin: 0; color: white; }

        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        @media (max-width: 1000px) { .main-grid { grid-template-columns: 1fr; } }

        button { width: 100%; padding: 15px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; font-family: 'Tajawal'; font-size: 1rem; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-red { background: rgba(255,69,58,0.15); color: var(--danger); border: 1px solid rgba(255,69,58,0.3); }

        .job-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-right: 4px solid var(--primary); }
        .job-info { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px; }
        .progress-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        .history-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--glass-border); font-size: 0.9rem; }

        #player-modal { display: none; position: fixed; bottom: 30px; left: 30px; width: 380px; background: rgba(20,20,20,0.95); backdrop-filter: blur(40px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; z-index: 1000; box-shadow: 0 30px 80px rgba(0,0,0,0.8); }
        a.download-link { display:inline-block; margin-top:8px; color:var(--primary); text-decoration:none; font-size:0.9rem; }
    </style>
</head>
<body>
    <canvas id="cosmos"></canvas>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-screen">
        <div class="login-box">
            <div class="login-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
            <div id="login-msg" style="color: var(--danger); margin-bottom: 10px; font-size: 0.9rem;"></div>

            <input type="text" id="username" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Admin)">
            <input type="password" id="password" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (admin)">

            <div class="auth-actions">
                <button class="btn-login" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„</button>
                <button class="btn-bio" onclick="triggerBiometric()" title="Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø©">
                    <i class="fas fa-fingerprint"></i>
                </button>
            </div>

            <p style="color: var(--text-sub); font-size: 0.8rem; margin-top: 20px;">
                Hyperion Secure Access v8.0
            </p>
        </div>
    </div>

    <!-- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="layout" id="dashboard">
        <header>
            <div class="brand"><h1>Ù‡Ø§ÙŠØ¨Ù€Ø±ÙŠÙˆÙ† <span>Ø£Ù„ØªÙŠÙ…ÙŠØª</span></h1></div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="text-align: left;">
                    <div style="font-size:0.8rem; color:var(--text-sub);">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·</div>
                    <div style="font-weight:bold; direction:ltr;" id="active-user-display">Admin</div>
                </div>
                <div class="live-dot" id="status-dot"></div>
                <button onclick="logout()" style="width: auto; padding: 5px 10px; font-size: 0.8rem; background: rgba(255,69,58,0.2); color: var(--danger);">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <div class="grid">
            <div class="panel">
                <span class="panel-label">Ø­Ù…Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬</span>
                <p class="panel-value" id="cpu">0%</p>
            </div>
            <div class="panel">
                <span class="panel-label">Ø§Ù„Ø°Ø§ÙƒØ±Ø© (RAM)</span>
                <p class="panel-value" id="ram">0%</p>
            </div>
            <div class="panel">
                <span class="panel-label">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù†Ø´Ø·Ø©</span>
                <p class="panel-value" id="active-jobs" style="color:var(--primary)">0</p>
            </div>
            <div class="panel">
                <span class="panel-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±</span>
                <p class="panel-value" id="status-text" style="color: var(--success); font-size: 1.5rem;">Ù…ØªØµÙ„ âœ…</p>
            </div>
        </div>

        <div class="main-grid">
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div class="panel">
                    <span class="panel-label"><i class="fas fa-search"></i> Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„</span>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <!-- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ‚Ø¨Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ Ø§Ø³ØªØ¹Ù„Ø§Ù… -->
                        <input type="text" id="query" class="login-input" style="margin:0" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«..." onkeypress="if(event.keyCode==13) runSearch()">
                        <button class="btn-blue" style="width: 120px;" onclick="runSearch()" id="search-btn">ØªØ­Ù…ÙŠÙ„</button>
                    </div>
                    <div style="margin-top:12px; font-size:0.85rem; color:var(--text-sub);">
                        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø¹Ø¨Ø§Ø±Ø© Ø¨Ø­Ø«. Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ ÙˆÙŠØ¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… Ù…Ø¨Ø§Ø´Ø±Ø©.
                    </div>
                </div>

                <div class="panel">
                    <span class="panel-label">Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</span>
                    <div id="active-jobs-list" style="min-height: 50px; color: var(--text-sub); font-size: 0.9rem;">Ø§Ù†ØªØ¸Ø§Ø±...</div>
                </div>

                <div class="panel">
                    <span class="panel-label">Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ù…Ø­Ù„ÙŠ)</span>
                    <div id="history-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div class="panel">
                    <span class="panel-label">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±</span>
                    <button class="btn-red" onclick="serverAction('stop')">ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù</button>
                </div>
                <div class="panel">
                    <span class="panel-label">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</span>
                    <div style="font-size: 0.8rem; color: var(--text-sub); direction: ltr;">
                        Session: <span style="color:var(--success)">Active</span><br>
                        Auto-Logout: <span id="timer-display">25:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…Ø´ØºÙ„ -->
    <div id="player-modal">
        <span style="position:absolute; top:15px; left:15px; cursor:pointer; color:var(--text-sub);" onclick="document.getElementById('player-modal').style.display='none'">âœ•</span>
        <div id="player-container"></div>
    </div>

    <script>
    /******************************************************************
     * Hyperion UI JS
     * - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ server.py (endpoints: /health, /api/jobs, /api/download, /ws/downloads/{client_id}, /stream/{filename})
     * - ÙƒÙ„ Ø§Ù„Ø´Ø±ÙˆØ­Ø§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
     ******************************************************************/

    // ---------- 1) Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Ø¬ÙˆÙ… ----------
    const canvas = document.getElementById('cosmos');
    const ctx = canvas.getContext && canvas.getContext('2d');
    let w, h, stars = [];
    const initStars = () => {
        w = window.innerWidth; h = window.innerHeight;
        canvas.width = w; canvas.height = h;
        stars = [];
        for (let i = 0; i < 150; i++) stars.push({ x: Math.random()*w, y: Math.random()*h, s: Math.random()*1.5, v: Math.random()*0.5 });
    };
    const draw = () => {
        if (!ctx) return;
        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = "rgba(255,255,255,0.8)";
        stars.forEach(st => {
            ctx.beginPath(); ctx.arc(st.x, st.y, st.s, 0, Math.PI*2); ctx.fill();
            st.y -= st.v; if (st.y < 0) st.y = h;
        });
        requestAnimationFrame(draw);
    };
    window.onresize = initStars; initStars(); draw();

    // ---------- 2) Ø¬Ù„Ø³Ø© ÙˆÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ----------
    window.onload = function() {
        const session = localStorage.getItem('hyperion_session');
        if (session === 'active') unlockDashboard(true);
        // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ client_id Ù„Ù„Ù€ websocket
        if (!localStorage.getItem('hyperion_client_id')) {
            localStorage.setItem('hyperion_client_id', generateUUID());
        }
        connectWS(); // Ø§ÙØªØ­ websocket ÙÙˆØ±Ø§Ù‹ (Ø³ÙŠØ¨Ù‚Ù‰ Ù…Ø¹Ù„Ù‚ Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„)
        refreshUI();
    };

    function attemptLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const msg = document.getElementById('login-msg');
        // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ø³ÙŠØ·Ø© (Ù„Ùˆ ØªØ±ØºØ¨ ØªØ¶ÙŠÙ auth Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø§Ø­Ù‚Ø§Ù‹)
        if (u === 'Admin' && p === 'admin') {
            msg.innerText = "";
            saveSession();
            unlockDashboard();
        } else {
            msg.innerText = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
        }
    }

    async function triggerBiometric() {
        const msg = document.getElementById('login-msg');
        msg.style.color = "var(--primary)";
        msg.innerText = "Ø¶Ø¹ Ø§ØµØ¨Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø±...";
        if (!window.PublicKeyCredential) {
            msg.style.color = "var(--danger)";
            msg.innerText = "Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¨ØµÙ…Ø©";
            return;
        }
        try {
            const publicKey = {
                challenge: new Uint8Array(32),
                rp: { name: "Hyperion" },
                user: { id: new Uint8Array(16), name: "User", displayName: "User" },
                pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                timeout: 60000,
                authenticatorSelection: { authenticatorAttachment: "platform" }
            };
            await navigator.credentials.create({ publicKey });
            msg.style.color = "var(--success)";
            msg.innerText = "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚!";
            setTimeout(()=>{ saveSession(); unlockDashboard(); }, 500);
        } catch (e) {
            msg.style.color = "var(--danger)";
            msg.innerText = "ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø£Ùˆ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡";
        }
    }

    function saveSession() {
        localStorage.setItem('hyperion_session', 'active');
        localStorage.setItem('login_time', Date.now());
    }

    function unlockDashboard(instant = false) {
        const screen = document.getElementById('login-screen');
        const dash = document.getElementById('dashboard');
        if (instant) screen.style.display = 'none';
        else { screen.style.opacity = '0'; setTimeout(()=> screen.style.display = 'none', 500); }
        dash.style.display = 'block';
        setTimeout(()=> { dash.style.filter = "blur(0)"; dash.style.opacity = "1"; }, 100);
        startInactivityTimer();
    }

    function logout() {
        localStorage.removeItem('hyperion_session');
        location.reload();
    }

    // ---------- 3) Ù…Ø¤Ù‚Øª Ø§Ù„Ø®Ù…ÙˆÙ„ ----------
    let logoutTimer;
    const TIMEOUT_DURATION = 25 * 60 * 1000;
    function startInactivityTimer() {
        resetTimer();
        document.onmousemove = resetTimer; document.onkeypress = resetTimer; document.ontouchstart = resetTimer;
    }
    function resetTimer() { clearTimeout(logoutTimer); logoutTimer = setTimeout(logout, TIMEOUT_DURATION); }

    // ---------- 4) WebSocket Ù„Ù„Ù€ real-time ----------
    let ws = null;
    const clientId = () => localStorage.getItem('hyperion_client_id') || generateUUID();
    function connectWS() {
        const id = clientId();
        try {
            const proto = (location.protocol === "https:") ? "wss:" : "ws:";
            ws = new WebSocket(`${proto}//${location.host}/ws/downloads/${encodeURIComponent(id)}`);
            ws.onopen = () => console.log("WS connected", id);
            ws.onmessage = (ev) => {
                try {
                    const d = JSON.parse(ev.data);
                    handleWS(d);
                } catch(e) { console.log("WS msg parse err", e); }
            };
            ws.onclose = () => { console.log("WS closed, reconnect in 2s"); setTimeout(connectWS, 2000); };
            ws.onerror = (e) => console.log("WS error", e);
        } catch (e) {
            console.warn("Cannot open ws", e);
        }
    }

    function handleWS(msg) {
        // Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: queued, started, progress, finished, error, status_response
        console.log("WS:", msg);
        if (!msg.event) return;
        if (msg.event === "queued") {
            addOrUpdateJobLocal(msg.job_id, { state: "queued", url: msg.url, progress: 0 });
            refreshUI();
        } else if (msg.event === "started") {
            addOrUpdateJobLocal(msg.job_id, { state: "processing", progress: 0 });
            refreshUI();
        } else if (msg.event === "progress") {
            addOrUpdateJobLocal(msg.job_id, { state: "processing", progress: msg.progress, speed: humanSize(msg.speed) + "/s", downloaded: msg.downloaded, total: msg.total });
            refreshUI();
        } else if (msg.event === "ydl_finished") {
            // Ø¥Ø´Ø¹Ø§Ø± Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚
            addOrUpdateJobLocal(msg.job_id, { state: "ydl_finished" });
            refreshUI();
        } else if (msg.event === "finished") {
            // msg.meta ÙŠØ­ØªÙˆÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (title, id, uploader...)
            const meta = msg.meta || {};
            addOrUpdateJobLocal(msg.job_id, { state: "finished", progress: 100, meta: meta, finished_at: Date.now() });
            // Ù†Ø¶ÙŠÙ Ù„Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ (history) â€” Ù†Ø­Ø§ÙˆÙ„ Ø¨Ù†Ø§Ø¡ Ø§Ø³Ù… Ù…Ù„Ù Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            const guessedFilename = safeFilename((meta.title || ("video_"+(meta.id||msg.job_id)))) + ".mp4";
            addToHistory({ job_id: msg.job_id, title: meta.title || "video", uploader: meta.uploader||"", size: meta.filesize || 0, file: guessedFilename, ts: Date.now() });
            refreshUI();
        } else if (msg.event === "error") {
            addOrUpdateJobLocal(msg.job_id, { state: "error", error: msg.error });
            refreshUI();
        } else if (msg.event === "status_response") {
            // ÙŠÙ…ÙƒÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù† Ø·Ù„Ø¨Ù†Ø§ Ù…Ù† Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒÙŠØª
            console.log("status_response", msg);
        }
    }

    function sendWS(obj) {
        if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
    }

    // ---------- 5) ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…: health, jobs, download ----------
    async function refreshUI() {
        updateStatusDisplay();
        await updateJobsFromServer();
        renderJobs();
        renderHistory();
    }

    async function updateStatusDisplay() {
        try {
            const res = await fetch('/health');
            if (!res.ok) { throw new Error("health failed"); }
            const j = await res.json();
            document.getElementById('cpu').innerText = (j.cpu || 0) + "%";
            document.getElementById('ram').innerText = (j.ram || 0) + "%";
            document.getElementById('active-jobs').innerText = (j.downloads_in_queue !== undefined) ? j.downloads_in_queue : "0";
            document.getElementById('status-text').innerText = j.ok ? "Ù…ØªØµÙ„ âœ…" : "ØºÙŠØ± Ù…ØªØµÙ„";
        } catch (e) {
            document.getElementById('status-text').innerText = "ØºÙŠØ± Ù…ØªØµÙ„ âŒ";
        }
    }

    // Ù†Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ù† /api/jobs (Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹ÙŠØ¯ ÙƒØ§Ø¦Ù† jobs: { job_id: {...} })
    let jobsMap = {}; // Ø­Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ© Ù…Ø±Ø¢Ø©
    async function updateJobsFromServer() {
        try {
            const res = await fetch('/api/jobs');
            if (!res.ok) return;
            const j = await res.json();
            // j.jobs Ù‡ÙŠ Ø®Ø±ÙŠØ·Ø© job_id -> status
            jobsMap = j.jobs || {};
            // Ù†Ø¯Ù…Ø¬Ù‡Ø§ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (add/update)
            for (const [jid, st] of Object.entries(jobsMap)) {
                addOrUpdateJobLocal(jid, st);
            }
        } catch (e) {
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ©
        }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªÙ†Ø²ÙŠÙ„ Ø¥Ù„Ù‰ /api/download
    async function runSearch() {
        const btn = document.getElementById('search-btn');
        const input = document.getElementById('query');
        const urlOrQuery = input.value && input.value.trim();
        if (!urlOrQuery) return;
        btn.disabled = true; btn.innerText = "...";
        try {
            // Ù†Ø±Ø³Ù„ JSON Ù…Ø¹ client_id Ù„Ù†Ø¶Ù…Ù† ØªÙ„Ù‚ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            const payload = { url: urlOrQuery, client_id: clientId() };
            const res = await fetch('/api/download', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!res.ok) {
                const txt = await res.text();
                alert("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†Ø²ÙŠÙ„: " + txt);
            } else {
                const data = await res.json();
                // Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹ÙŠØ¯ job_id
                // Ù†Ø¶ÙŠÙ Ø­Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ© Ù…Ø¨Ø¯Ø¦ÙŠØ©
                if (data.job_id) addOrUpdateJobLocal(data.job_id, { state: "queued", url: urlOrQuery, progress: 0 });
                input.value = "";
            }
        } catch (e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
            console.error(e);
        } finally {
            btn.disabled = false; btn.innerText = "Ø¨Ø­Ø«";
            await refreshUI();
        }
    }

    // ---------- 6) Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù€ jobs Ù…Ø­Ù„ÙŠØ§Ù‹ ----------
    // Ù†Ø®Ø²Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ localStorage Ù„ÙƒÙŠ ØªØ¨Ù‚Ù‰ Ø¹Ø¨Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    function getLocalJobs() {
        try { return JSON.parse(localStorage.getItem('hyperion_jobs')||'{}'); } catch(e){ return {}; }
    }
    function saveLocalJobs(m) { localStorage.setItem('hyperion_jobs', JSON.stringify(m)); }
    function addOrUpdateJobLocal(job_id, data) {
        const m = getLocalJobs();
        m[job_id] = Object.assign({}, m[job_id] || {}, data);
        m[job_id]._updated = Date.now();
        saveLocalJobs(m);
    }
    function removeLocalJob(job_id) {
        const m = getLocalJobs();
        delete m[job_id];
        saveLocalJobs(m);
    }

    function renderJobs() {
        const container = document.getElementById('active-jobs-list');
        const m = getLocalJobs();
        const arr = Object.entries(m).sort((a,b)=> (b[1]._updated||0)-(a[1]._updated||0));
        if (!arr.length) { container.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù†Ø´Ø·Ø©"; return; }
        container.innerHTML = arr.map(([jid, info]) => {
            const title = (info.meta && info.meta.title) ? info.meta.title : (info.url || jid);
            const progress = info.progress !== undefined ? info.progress : (info.state === 'finished' ? 100 : 0);
            const speed = info.speed || "";
            const extra = info.state === 'error' ? `<div style="color:var(--danger); margin-top:6px;">Ø®Ø·Ø£: ${escapeHtml(info.error||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}</div>` : '';
            const playBtn = (info.state === 'finished' && info.meta) ? `<button class="btn-blue" style="width:auto; padding:8px 12px; margin-top:8px;" onclick="playFromJob('${encodeURIComponent(jid)}')">ØªØ´ØºÙŠÙ„</button>` : '';
            return `
                <div class="job-card">
                    <div class="job-info"><span>${escapeHtml(title)}</span><span style="color:var(--success)">${speed}</span></div>
                    <div class="progress-track"><div class="progress-fill" style="width:${progress}%"></div></div>
                    ${playBtn}
                    ${extra}
                </div>
            `;
        }).join('');
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† job: Ù†Ø­Ø§ÙˆÙ„ Ø¨Ù†Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† title (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„ outtmpl ÙÙŠ server Ù„ÙŠØªØ·Ø§Ø¨Ù‚)
    function playFromJob(encodedJobId) {
        const jid = decodeURIComponent(encodedJobId);
        const m = getLocalJobs();
        const info = m[jid];
        if (!info || !info.meta) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©."); return; }
        const title = info.meta.title || ('video_'+(info.meta.id||jid));
        const guessed = safeFilename(title) + ".mp4"; // ØªÙˆÙ‚Ø¹ Ø§Ø³Ù… Ù…Ù„Ù Ø¨ØµÙŠØºØ© mp4
        playMedia(guessed, title);
    }

    // ---------- 7) Ø§Ù„Ø³Ø¬Ù„ (History) Ù…Ø­Ù„ÙŠ ----------
    function getHistory() {
        try { return JSON.parse(localStorage.getItem('hyperion_history')||'[]'); } catch(e){ return []; }
    }
    function saveHistory(arr) { localStorage.setItem('hyperion_history', JSON.stringify(arr)); }
    function addToHistory(item) {
        const arr = getHistory();
        arr.unshift(item);
        // Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø­Ø¯ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø¢Ø®Ø± 100)
        if (arr.length > 200) arr.length = 200;
        saveHistory(arr);
    }
    function renderHistory() {
        const arr = getHistory();
        const container = document.getElementById('history-list');
        if (!arr.length) { container.innerHTML = "<div style='color:var(--text-sub)'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ø¹Ø¯</div>"; return; }
        container.innerHTML = arr.map(i => `
            <div class="history-item">
                <div style="flex:1">
                    <b>${escapeHtml(i.title.substring(0,60))}</b><br>
                    <small style="color:var(--text-sub)">${i.uploader || ''} Â· ${humanSize(i.size||0)}</small>
                </div>
                <div style="display:flex; gap:8px; align-items:center">
                    <button class="btn-blue" style="width:auto; padding:8px 12px;" onclick="playMedia('${encodeURIComponent(i.file)}','${escapeHtml(i.title)}')">ØªØ´ØºÙŠÙ„</button>
                    <a class="download-link" href="/stream/${encodeURIComponent(i.file)}" target="_blank">ØªØ­Ù…ÙŠÙ„</a>
                </div>
            </div>
        `).join('');
    }

    // ---------- 8) ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (modal) ----------
    function playMedia(filePath, title) {
        const modal = document.getElementById('player-modal');
        const container = document.getElementById('player-container');
        modal.style.display = 'block';
        // Ù†Ø¹Ø±Ø¶ ÙÙŠØ¯ÙŠÙˆ HTML5 Ù…Ø¹ src Ø¥Ù„Ù‰ /stream/{filePath} (Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¯Ø¹Ù… Range)
        container.innerHTML = `
            <div style="font-weight:700; margin-bottom:10px;">${title || decodeURIComponent(filePath)}</div>
            <video controls autoplay style="width:100%; border-radius:10px;">
                <source src="/stream/${filePath}" type="video/mp4">
                Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
            </video>
            <div style="margin-top:8px; display:flex; gap:8px;">
                <a class="download-link" href="/stream/${filePath}" target="_blank">ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
                <button class="btn-red" style="width:auto; padding:6px 10px;" onclick="document.getElementById('player-modal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        `;
    }

    // ---------- 9) Ø£ÙØ¹Ø§Ù„ Ø¥Ø¯Ø§Ø±ÙŠØ© (Ù…Ø¤Ù‚Øª) ----------
    function serverAction(act) {
        if (act === 'stop') {
            alert('Ø²Ø± Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ù…ÙˆØ¬Ù‡ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·. Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø§Ø¯Ù… ÙØ¹Ù„ÙŠÙ‹Ø§ Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ©.');
        }
    }

    // ---------- 10) ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ----------
    function generateUUID() {
        // UUID Ø¨Ø³ÙŠØ·
        return 'xxxxxxxxyxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
            return v.toString(16);
        }) + Date.now().toString(36);
    }
    function safeFilename(s) {
        // Ø¥Ø²Ø§Ù„Ø© Ø£Ø­Ø±Ù ØºÙŠØ± Ø¢Ù…Ù†Ø© Ù„ØªÙˆÙ‚Ø¹ Ø§Ø³Ù… Ù…Ù„Ù
        return (s || '').replace(/[^0-9a-zA-ZØ¡-ÙŠ \-_\.]/g, '').trim().replace(/\s+/g, '_').substring(0,180);
    }
    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/[&<>"'`=\/]/g, function(s) {
            return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[s];
        });
    }
    function humanSize(n) {
        if (!n || n <= 0) return "0 B";
        const units = ["B","KB","MB","GB","TB"];
        let i = 0;
        while (n >= 1024 && i < units.length-1) { n /= 1024; i++; }
        return `${n.toFixed(2)} ${units[i]}`;
    }

    // ---------- 11) ØªÙƒØ§Ù…Ù„ Ø¯ÙˆØ±ÙŠ ----------
    setInterval(refreshUI, 2000);
    setInterval(renderHistory, 5000);

    </script>
</body>
</html>
