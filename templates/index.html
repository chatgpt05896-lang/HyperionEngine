<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù‡Ø§ÙŠØ¨Ù€Ø±ÙŠÙˆÙ† Ø£Ù„ØªÙŠÙ…ÙŠØª | ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>

    <!-- Ø®Ø·ÙˆØ· ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root{
            --bg-deep: #000000;
            --glass: rgba(28,28,30,0.85);
            --glass-border: rgba(255,255,255,0.08);
            --primary: #0A84FF;
            --danger: #FF453A;
            --success: #30D158;
            --text-main: #FFFFFF;
            --text-sub: #98989D;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg-deep);color:var(--text-main);font-family:'Tajawal',sans-serif;min-height:100vh;overflow-x:hidden}
        #cosmos{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;background:radial-gradient(circle at center,#1c1c1e 0%,#000 100%)}

        /* --- Login --- */
        #login-screen{position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(20px);transition:opacity .4s}
        .login-box{width:360px;background:var(--glass);border:1px solid var(--glass-border);padding:36px;border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.6);text-align:center}
        .login-title{font-size:1.6rem;font-weight:900;margin-bottom:18px;color:var(--text-main)}
        .login-input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.02);color:var(--text-main);margin-bottom:12px;outline:none}
        .auth-actions{display:flex;gap:10px}
        .btn-login{flex:2;padding:12px;border-radius:10px;border:0;background:var(--primary);color:#fff;cursor:pointer;font-weight:800}
        .btn-bio{flex:1;padding:12px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.02);color:var(--primary);cursor:pointer}

        /* --- Dashboard --- */
        .layout{max-width:1300px;margin:0 auto;padding:36px 20px;display:none;opacity:0;filter:blur(8px);transition:all .6s}
        header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-radius:18px;background:var(--glass);border:1px solid var(--glass-border);backdrop-filter:blur(18px);margin-bottom:28px}
        .brand h1{margin:0;font-weight:900;font-size:1.8rem}
        .brand span{color:var(--primary);font-weight:900}
        .live-dot{height:12px;width:12px;border-radius:50%;background:var(--success);box-shadow:0 0 12px var(--success);display:inline-block;margin-left:10px;animation:pulse 2s infinite}
        @keyframes pulse{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}

        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:22px}
        .panel{background:var(--glass);border-radius:16px;padding:20px;border:1px solid var(--glass-border);backdrop-filter:blur(12px)}
        .panel-label{color:var(--text-sub);font-size:.9rem;margin-bottom:6px}
        .panel-value{font-size:1.8rem;font-weight:800}

        .main-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px}
        @media(max-width:1000px){.main-grid{grid-template-columns:1fr}}

        button{font-weight:700;border-radius:12px;padding:12px;border:0;cursor:pointer}
        .btn-blue{background:var(--primary);color:#fff}
        .btn-red{background:rgba(255,69,58,0.12);color:var(--danger);border:1px solid rgba(255,69,58,0.18)}

        .job-card{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;margin-bottom:10px;display:block}
        .job-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:.95rem}
        .progress-track{height:8px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden}
        .progress-fill{height:100%;background:var(--primary);width:0;transition:width .25s}

        .history-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--glass-border);font-size:.9rem}
        .download-link{color:var(--primary);text-decoration:none;font-size:.9rem;margin-left:8px}

        #player-modal{display:none;position:fixed;right:20px;bottom:20px;width:420px;background:rgba(12,12,12,0.96);border-radius:12px;padding:14px;border:1px solid var(--glass-border);z-index:999}
        #player-modal video{width:100%;border-radius:8px}

        /* small */
        small{color:var(--text-sub)}
    </style>
</head>
<body>
    <canvas id="cosmos"></canvas>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-screen">
        <div class="login-box">
            <div class="login-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
            <div id="login-msg" style="color:var(--danger);margin-bottom:10px;font-size:.9rem"></div>
            <input id="username" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Admin)">
            <input id="password" type="password" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (admin)">
            <div class="auth-actions">
                <button class="btn-login" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„</button>
                <button class="btn-bio" onclick="triggerBiometric()" title="Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø©"><i class="fas fa-fingerprint"></i></button>
            </div>
            <p style="color:var(--text-sub);font-size:.82rem;margin-top:14px">Hyperion Secure Access v8.0</p>
        </div>
    </div>

    <!-- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -->
    <div class="layout" id="dashboard">
        <header>
            <div class="brand"><h1>Ù‡Ø§ÙŠØ¨Ù€Ø±ÙŠÙˆÙ† <span>Ø£Ù„ØªÙŠÙ…ÙŠØª</span></h1></div>
            <div style="display:flex;align-items:center;gap:12px">
                <div style="text-align:left">
                    <div style="font-size:.82rem;color:var(--text-sub)">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø·</div>
                    <div style="font-weight:800;direction:ltr" id="active-user-display">Admin</div>
                </div>
                <div class="live-dot" id="status-dot"></div>
                <button onclick="logout()" style="padding:7px 10px;background:rgba(255,69,58,0.12);color:var(--danger);border-radius:10px">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <div class="grid">
            <div class="panel">
                <div class="panel-label">Ø­Ù…Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬</div>
                <div class="panel-value" id="cpu">0%</div>
            </div>
            <div class="panel">
                <div class="panel-label">Ø§Ù„Ø°Ø§ÙƒØ±Ø© (RAM)</div>
                <div class="panel-value" id="ram">0%</div>
            </div>
            <div class="panel">
                <div class="panel-label">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù†Ø´Ø·Ø©</div>
                <div class="panel-value" id="active-jobs">0</div>
            </div>
            <div class="panel">
                <div class="panel-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±</div>
                <div class="panel-value" id="status-text" style="color:var(--success);font-size:1.2rem">Ù…ØªØµÙ„ âœ…</div>
            </div>
        </div>

        <div class="main-grid">
            <div style="display:flex;flex-direction:column;gap:18px">
                <div class="panel">
                    <div class="panel-label"><i class="fas fa-search"></i> Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„</div>
                    <div style="display:flex;gap:10px;margin-top:12px">
                        <input id="query" class="login-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø¹Ø¨Ø§Ø±Ø© Ø¨Ø­Ø«..." onkeypress="if(event.keyCode==13) runSearch()">
                        <button id="search-btn" class="btn-blue" onclick="runSearch()">ØªØ­Ù…ÙŠÙ„</button>
                    </div>
                    <div style="margin-top:10px;color:var(--text-sub);font-size:.86rem">Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ ÙƒØ§Ù…Ù„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø« â€” Ø³ØªØªÙ… Ø§Ù„Ø¥Ø®Ø·Ø§Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± WebSocket.</div>
                </div>

                <div class="panel">
                    <div class="panel-label">Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</div>
                    <div id="active-jobs-list" style="min-height:80px;color:var(--text-sub)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù†Ø´Ø·Ø©</div>
                </div>

                <div class="panel">
                    <div class="panel-label">Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ù…Ø­Ù„ÙŠ)</div>
                    <div id="history-list" style="max-height:300px;overflow:auto"></div>
                </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:18px">
                <div class="panel">
                    <div class="panel-label">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±</div>
                    <button class="btn-red" onclick="stopServer()">ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø§Ø¯Ù…</button>
                    <button class="btn-blue" style="margin-top:10px" onclick="clearCache()">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´ (20 Ø¯')</button>
                </div>

                <div class="panel">
                    <div class="panel-label">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</div>
                    <div style="font-size:.86rem;color:var(--text-sub);direction:ltr">
                        Session: <span style="color:var(--success)">Active</span><br>
                        Auto-Logout: <span id="timer-display">25:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- player modal -->
    <div id="player-modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong id="player-title">Player</strong>
            <button onclick="document.getElementById('player-modal').style.display='none'" style="background:transparent;color:var(--text-sub);border:0">âœ•</button>
        </div>
        <div id="player-container"></div>
    </div>

    <script>
    /*****************************************
     * Hyperion UI JS â€” ØªÙØ§Ø¹Ù„ ÙƒØ§Ù…Ù„ Ù…Ø¹ server.py
     *****************************************/

    // background stars
    const canvas = document.getElementById('cosmos');
    let ctx = null;
    if (canvas && canvas.getContext) ctx = canvas.getContext('2d');
    let w=0,h=0,stars=[];
    const initStars = ()=>{ w=window.innerWidth; h=window.innerHeight; canvas.width=w; canvas.height=h; stars=[]; for(let i=0;i<140;i++){ stars.push({x:Math.random()*w,y:Math.random()*h,s:Math.random()*1.6,v:Math.random()*0.6}) } }
    const draw = ()=>{ if(!ctx) return; ctx.clearRect(0,0,w,h); ctx.fillStyle="rgba(255,255,255,0.8)"; stars.forEach(st=>{ ctx.beginPath(); ctx.arc(st.x,st.y,st.s,0,Math.PI*2); ctx.fill(); st.y -= st.v; if(st.y<0) st.y = h; }); requestAnimationFrame(draw); }
    window.onresize = initStars; initStars(); draw();

    // Utilities
    function generateUUID(){ return 'xxxxxxxxyxxx'.replace(/[xy]/g,function(c){const r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16)}) + Date.now().toString(36) }
    function safeFilename(s){ return (s||'').replace(/[^0-9a-zA-ZØ¡-ÙŠ \-_.]/g,'').trim().replace(/\s+/g,'_').slice(0,180) }
    function humanSize(n){ if(!n||n<=0) return '0 B'; const u=['B','KB','MB','GB','TB']; let i=0; while(n>=1024&&i<u.length-1){ n/=1024; i++ } return `${n.toFixed(2)} ${u[i]}` }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`=\/]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c] }) }

    // Session + client id
    if(!localStorage.getItem('hyperion_client_id')) localStorage.setItem('hyperion_client_id', generateUUID());
    const clientId = ()=> localStorage.getItem('hyperion_client_id');

    // local storage for jobs & history (so UI persistent)
    function loadLocalJobs(){ try{ return JSON.parse(localStorage.getItem('hyperion_jobs')||'{}') }catch(e){return{}} }
    function saveLocalJobs(m){ try{ localStorage.setItem('hyperion_jobs', JSON.stringify(m)) }catch(e){} }
    function addOrUpdateJobLocal(id,data){ const m=loadLocalJobs(); m[id]=Object.assign({},m[id]||{},data); m[id]._updated=Date.now(); saveLocalJobs(m) }
    function removeLocalJob(id){ const m=loadLocalJobs(); delete m[id]; saveLocalJobs(m) }

    function loadHistory(){ try{ return JSON.parse(localStorage.getItem('hyperion_history')||'[]') }catch(e){return[]} }
    function saveHistory(a){ try{ localStorage.setItem('hyperion_history', JSON.stringify(a)) }catch(e){} }
    function addToHistory(item){ const arr=loadHistory(); arr.unshift(item); if(arr.length>200) arr.length=200; saveHistory(arr) }

    // WebSocket
    let ws = null;
    function connectWS(){
        const id = clientId();
        try{
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}/ws/downloads/${encodeURIComponent(id)}`);
            ws.onopen = ()=> console.log('WS open', id);
            ws.onmessage = ev => {
                try{
                    const msg = JSON.parse(ev.data);
                    handleWS(msg);
                }catch(e){ console.log('ws parse err', e) }
            };
            ws.onclose = ()=> { console.log('WS closed â€” reconnecting'); setTimeout(connectWS,2000) };
            ws.onerror = e => console.log('ws err', e);
        }catch(e){ console.warn('ws open failed', e) }
    }
    connectWS();

    // Handle WS messages
    function handleWS(msg){
        if(!msg || !msg.event) return;
        if(msg.event === 'queued'){ addOrUpdateJobLocal(msg.job_id, { state:'queued', url: msg.url, progress:0 }); refreshUI(); }
        else if(msg.event === 'started'){ addOrUpdateJobLocal(msg.job_id, { state:'processing', progress:0 }); refreshUI(); }
        else if(msg.event === 'progress'){ addOrUpdateJobLocal(msg.job_id, { state:'processing', progress: msg.progress, speed: humanSize(msg.speed||0) + '/s', downloaded: msg.downloaded, total: msg.total }); refreshUI(); }
        else if(msg.event === 'ydl_finished'){ addOrUpdateJobLocal(msg.job_id, { state:'ydl_finished' }); refreshUI(); }
        else if(msg.event === 'finished'){
            const meta = msg.meta || {};
            addOrUpdateJobLocal(msg.job_id, { state:'finished', progress:100, meta: meta, filename: msg.filename });
            // add to history (prefer filename if present)
            const fname = msg.filename || (safeFilename(meta.title||('video_'+(meta.id||msg.job_id))) + '.mp4');
            addToHistory({ job_id: msg.job_id, title: meta.title||fname, uploader: meta.uploader||'', size: meta.filesize||0, file: fname, ts: Date.now() });
            refreshUI();
        }
        else if(msg.event === 'error'){ addOrUpdateJobLocal(msg.job_id, { state:'error', error: msg.error }); refreshUI(); }
    }

    // API helper
    async function api(path, method='GET', body=null){
        const opts = { method, headers:{} };
        if(body){ opts.headers['Content-Type']='application/json'; opts.body=JSON.stringify(body) }
        const res = await fetch(path, opts);
        return res;
    }

    // Health & jobs update
    async function refreshUI(){
        updateStatusDisplay();
        await updateJobsFromServer();
        renderJobs();
        renderHistory();
    }

    async function updateStatusDisplay(){
        try{
            const res = await api('/health');
            if(!res.ok) throw new Error('health failed');
            const j = await res.json();
            document.getElementById('cpu').innerText = (j.cpu||0) + '%';
            document.getElementById('ram').innerText = (j.ram||0) + '%';
            document.getElementById('active-jobs').innerText = (j.downloads_in_queue!==undefined)? j.downloads_in_queue : Object.keys(loadLocalJobs()).length;
            document.getElementById('status-text').innerText = j.ok ? 'Ù…ØªØµÙ„ âœ…' : 'ØºÙŠØ± Ù…ØªØµÙ„';
        }catch(e){
            document.getElementById('status-text').innerText = 'ØºÙŠØ± Ù…ØªØµÙ„ âŒ';
        }
    }

    async function updateJobsFromServer(){
        try{
            const res = await api('/api/jobs');
            if(!res.ok) return;
            const j = await res.json();
            const map = j.jobs || {};
            // Ø¯Ù…Ø¬
            for(const [jid, st] of Object.entries(map)){
                const local = loadLocalJobs()[jid] || {};
                const merged = Object.assign({}, local, st);
                addOrUpdateJobLocal(jid, merged);
            }
        }catch(e){}
    }

    function renderJobs(){
        const container = document.getElementById('active-jobs-list');
        const m = loadLocalJobs();
        const arr = Object.entries(m).sort((a,b)=> (b[1]._updated||0) - (a[1]._updated||0));
        if(!arr.length){ container.innerHTML = '<div style="color:var(--text-sub)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù†Ø´Ø·Ø©</div>'; return; }
        container.innerHTML = arr.map(([jid, info])=>{
            const title = (info.meta && info.meta.title) ? info.meta.title : (info.url || jid);
            const progress = info.progress!==undefined ? info.progress : (info.state==='finished'?100:0);
            const speed = info.speed || '';
            const err = info.state==='error' ? `<div style="color:var(--danger);margin-top:6px">Ø®Ø·Ø£: ${escapeHtml(info.error||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}</div>` : '';
            const playBtn = (info.state==='finished' && (info.filename || (info.meta && info.meta.id))) ? `<button class="btn-blue" style="margin-top:8px;padding:8px 12px" onclick="playFromJob('${encodeURIComponent(jid)}')">ØªØ´ØºÙŠÙ„</button>` : '';
            return `<div class="job-card">
                <div class="job-info"><span>${escapeHtml(title)}</span><span style="color:var(--text-sub)">${speed}</span></div>
                <div class="progress-track"><div class="progress-fill" style="width:${progress}%"></div></div>
                ${playBtn}
                ${err}
            </div>`;
        }).join('');
    }

    function renderHistory(){
        // Ù†Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
        const container = document.getElementById('history-list');
        const arr = loadHistory();
        if(!arr.length){ container.innerHTML = '<div style="color:var(--text-sub)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ø¹Ø¯</div>'; return; }
        container.innerHTML = arr.map(i=>{
            const title = escapeHtml((i.title||i.file).slice(0,60));
            const file = encodeURIComponent(i.file);
            return `<div class="history-item">
                <div style="flex:1"><b>${title}</b><br><small style="color:var(--text-sub)">${escapeHtml(i.uploader||'')} Â· ${humanSize(i.size||0)}</small></div>
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="btn-blue" style="padding:8px 12px" onclick="playMedia('${file}','${escapeHtml(i.title||i.file)}')">ØªØ´ØºÙŠÙ„</button>
                    <a class="download-link" href="/stream/${file}" target="_blank">ØªØ­Ù…ÙŠÙ„</a>
                </div>
            </div>`;
        }).join('');
    }

    // Play controls
    function playFromJob(encJobId){
        const jid = decodeURIComponent(encJobId);
        const info = loadLocalJobs()[jid];
        if(!info) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©');
        const fname = info.filename || (info.meta && info.meta.id ? (info.meta.id + '.mp4') : null);
        const title = (info.meta && info.meta.title) ? info.meta.title : ('video_'+jid);
        if(!fname) return alert('Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ØªÙˆÙØ± Ø¨Ø¹Ø¯');
        playMedia(encodeURIComponent(fname), title);
    }

    function playMedia(filePath, title){
        const modal = document.getElementById('player-modal');
        const container = document.getElementById('player-container');
        document.getElementById('player-title').innerText = title || decodeURIComponent(filePath);
        container.innerHTML = `<video controls autoplay><source src="/stream/${filePath}" type="video/mp4">Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</video>
            <div style="margin-top:8px;display:flex;gap:8px"><a class="download-link" href="/stream/${filePath}" target="_blank">ÙØªØ­ / ØªØ­Ù…ÙŠÙ„</a>
            <button class="btn-red" onclick="document.getElementById('player-modal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button></div>`;
        modal.style.display = 'block';
    }

    // Actions: download / search / clear cache / stop server
    async function runSearch(){
        const input = document.getElementById('query');
        const q = (input.value||'').trim();
        if(!q) return;
        const btn = document.getElementById('search-btn');
        btn.disabled = true; btn.innerText = '...';
        try{
            const payload = { url: q, client_id: clientId() };
            const res = await api('/api/download','POST',payload);
            if(!res.ok){ const txt = await res.text(); alert('ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†Ø²ÙŠÙ„: '+txt); }
            else {
                const data = await res.json();
                if(data.job_id) addOrUpdateJobLocal(data.job_id,{ state:'queued', url:q, progress:0});
                input.value = '';
            }
        }catch(e){
            alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            console.error(e);
        }finally{
            btn.disabled=false; btn.innerText='ØªØ­Ù…ÙŠÙ„';
            setTimeout(refreshUI,800);
        }
    }

    async function clearCache(){
        try{
            const res = await api('/api/clear_cache','POST');
            if(res.ok) alert('ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´'); else alert('ÙØ´Ù„ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´');
        }catch(e){ alert('ÙØ´Ù„ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´'); }
    }

    async function stopServer(){
        if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø§Ø¯Ù…ØŸ')) return;
        try{
            const res = await api('/api/stop','POST');
            if(res.ok) alert('Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø£ÙØ±Ø³Ù„'); else alert('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù');
        }catch(e){ alert('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù'); }
    }

    // login/session
    function attemptLogin(){
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const msg = document.getElementById('login-msg');
        if(u==='Admin' && p==='admin'){ localStorage.setItem('hyperion_session','active'); unlockDashboard(); } else { msg.innerText='Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©' }
    }
    function triggerBiometric(){ alert('Ù…ÙŠØ²Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© â€” WebAuthn ØªØ­ØªØ§Ø¬ backend'); }
    function logout(){ localStorage.removeItem('hyperion_session'); location.reload(); }

    function unlockDashboard(instant=false){
        const screen = document.getElementById('login-screen');
        const dash = document.getElementById('dashboard');
        if(instant) screen.style.display='none'; else { screen.style.opacity='0'; setTimeout(()=>screen.style.display='none',400) }
        dash.style.display='block'; setTimeout(()=>{ dash.style.opacity=1; dash.style.filter='none' },120);
    }

    // inactivity auto logout (25 min)
    let logoutTimer; const TIMEOUT = 25*60*1000;
    function startInactivity(){ resetTimer(); document.onmousemove=resetTimer; document.onkeypress=resetTimer; document.ontouchstart=resetTimer; }
    function resetTimer(){ clearTimeout(logoutTimer); logoutTimer=setTimeout(()=>{ localStorage.removeItem('hyperion_session'); location.reload(); }, TIMEOUT) }

    // initial load
    window.onload = function(){
        if(localStorage.getItem('hyperion_session')==='active') unlockDashboard(true);
        startInactivity();
        connectWS();
        setInterval(refreshUI,2500);
        setInterval(renderHistory,5000);
        refreshUI();
    };

    </script>
</body>
</html>
