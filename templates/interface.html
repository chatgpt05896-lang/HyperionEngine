<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperion Ultimate | Admin Console</title>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #000000;
            --glass: rgba(28, 28, 30, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #0A84FF;
            --danger: #FF453A;
            --success: #30D158;
            --warning: #FFD60A;
            --text-main: #FFFFFF;
            --text-sub: #8E8E93;
        }

        body { margin: 0; background-color: var(--bg-deep); color: var(--text-main); font-family: 'SF Pro Display', sans-serif; overflow-x: hidden; min-height: 100vh; }
        
        #cosmos { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1c1c1e 0%, #000000 100%); }

        .layout { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding: 20px 30px; background: var(--glass); backdrop-filter: blur(25px); border-radius: 24px; border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .brand h1 { font-weight: 700; font-size: 1.8rem; margin: 0; letter-spacing: -0.5px; }
        .brand span { color: var(--primary); font-size: 0.8em; text-transform: uppercase; letter-spacing: 2px; margin-left: 10px; }
        .live-dot { height: 10px; width: 10px; background-color: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 10px var(--success); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .panel { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 25px; transition: 0.3s; position: relative; overflow: hidden; }
        .panel:hover { transform: translateY(-3px); border-color: rgba(255,255,255,0.2); }
        .panel-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-sub); letter-spacing: 1px; display: block; margin-bottom: 8px; }
        .panel-value { font-size: 1.8rem; font-weight: 700; margin: 0; background: linear-gradient(180deg, #fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        input, select { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 15px; border-radius: 12px; color: white; font-size: 1rem; outline: none; box-sizing: border-box; margin-bottom: 10px; transition: 0.3s; }
        input:focus { border-color: var(--primary); }

        button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-blue { background: var(--primary); color: white; } .btn-blue:hover { opacity: 0.9; }
        .btn-red { background: rgba(255,69,58,0.15); color: var(--danger); border: 1px solid rgba(255,69,58,0.3); } .btn-red:hover { background: var(--danger); color: white; }
        .btn-green { background: rgba(48,209,88,0.15); color: var(--success); border: 1px solid rgba(48,209,88,0.3); } .btn-green:hover { background: var(--success); color: white; }

        .result-row { display: flex; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 8px; border: 1px solid transparent; }
        .result-row:hover { border-color: var(--glass-border); background: rgba(255,255,255,0.06); }
        .result-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 15px; }
        .result-meta { flex: 1; }
        .result-meta h4 { margin: 0 0 3px 0; font-size: 0.95rem; font-weight: 500; }
        .result-meta span { color: var(--text-sub); font-size: 0.75rem; }
        .tag { padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer; margin-left: 5px; }
        .tag-aud { background: rgba(10, 132, 255, 0.2); color: var(--primary); }
        .tag-vid { background: rgba(48, 209, 88, 0.2); color: var(--success); }

        /* Key Manager */
        .key-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 5px; font-family: monospace; font-size: 0.9rem; }
        .key-copy { color: var(--success); cursor: pointer; margin-left: 10px; }
        
        /* Media Player Modal */
        #player-modal { display: none; position: fixed; bottom: 30px; right: 30px; width: 350px; background: rgba(20,20,20,0.95); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; z-index: 1000; box-shadow: 0 20px 60px rgba(0,0,0,0.8); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #player-title { font-size: 0.9rem; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        audio, video { width: 100%; border-radius: 8px; outline: none; }
        .close-player { position: absolute; top: 10px; right: 10px; cursor: pointer; color: var(--danger); font-weight: bold; }

        /* Upload Zone */
        .upload-zone { border: 2px dashed var(--glass-border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; color: var(--text-sub); }
        .upload-zone:hover { border-color: var(--primary); color: var(--primary); background: rgba(10,132,255,0.05); }
    </style>
</head>
<body>
    <canvas id="cosmos"></canvas>

    <div id="player-modal">
        <span class="close-player" onclick="document.getElementById('player-modal').style.display='none'">âœ•</span>
        <div id="player-title">Now Playing...</div>
        <div id="player-container"></div>
    </div>

    <div class="layout">
        <header>
            <div class="brand"><h1>Hyperion <span>Ultimate</span></h1></div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size:0.9rem; color:var(--text-sub);">Logged in as: <b style="color:white">{{ user }}</b></span>
                <div class="live-dot" id="status-dot"></div>
            </div>
        </header>

        <div class="grid">
            <div class="panel">
                <span class="panel-label">System Load</span>
                <p class="panel-value" id="cpu">0%</p>
            </div>
            <div class="panel">
                <span class="panel-label">Total Downloads</span>
                <p class="panel-value" id="downloads">0</p>
            </div>
            <div class="panel">
                <span class="panel-label">Files Uploaded</span>
                <p class="panel-value" id="uploads">0</p>
            </div>
            <div class="panel">
                <span class="panel-label">Server Status</span>
                <p class="panel-value" id="status-text" style="font-size: 1.2rem; color: var(--success);">ACTIVE</p>
            </div>
        </div>

        <div class="main-grid">
            <div style="display: flex; flex-direction: column; gap: 20px;">
                
                <div class="panel">
                    <span class="panel-label">Global Media Search</span>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="text" id="query" placeholder="Song name, YouTube URL..." onkeypress="if(event.keyCode==13) runSearch()">
                        <button class="btn-blue" style="width: 100px;" onclick="runSearch()" id="search-btn">Search</button>
                    </div>
                    <div id="results" style="margin-top: 15px; max-height: 400px; overflow-y: auto;"></div>
                </div>

                <div class="panel">
                    <span class="panel-label">Secure File Upload</span>
                    <div class="upload-zone" onclick="document.getElementById('file-input').click()">
                        <span id="upload-text">Click to Upload Files</span>
                        <input type="file" id="file-input" style="display: none;" onchange="handleUpload(this)">
                    </div>
                    <div id="upload-result" style="margin-top: 10px; font-size: 0.9rem; color: var(--success);"></div>
                </div>

            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                
                <div class="panel">
                    <span class="panel-label">Server Control</span>
                    <select id="speed" onchange="setSpeed()" style="margin-top:10px;">
                        <option value="0">Unlimited Speed âš¡</option>
                        <option value="2048">2 MB/s</option>
                        <option value="512">512 KB/s</option>
                    </select>
                    <button class="btn-red" id="toggle-btn" onclick="toggleSystem()">Suspend System</button>
                </div>

                <div class="panel">
                    <span class="panel-label">API Access Keys</span>
                    <button class="btn-green" style="padding: 10px; margin-bottom: 10px;" onclick="createKey()">+ Generate New Key</button>
                    <div id="keys-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- Starfield ---
        const canvas = document.getElementById('cosmos');
        const ctx = canvas.getContext('2d');
        let w, h, stars = [];
        const initStars = () => { w = window.innerWidth; h = window.innerHeight; canvas.width = w; canvas.height = h; stars = []; for(let i=0; i<150; i++) stars.push({x: Math.random()*w, y: Math.random()*h, s: Math.random()*1.5, v: Math.random()*0.5}); };
        const draw = () => { ctx.clearRect(0,0,w,h); ctx.fillStyle = "rgba(255,255,255,0.8)"; stars.forEach(st => { ctx.beginPath(); ctx.arc(st.x, st.y, st.s, 0, Math.PI*2); ctx.fill(); st.y -= st.v; if(st.y < 0) st.y = h; }); requestAnimationFrame(draw); };
        window.onresize = initStars; initStars(); draw();

        // --- Core Functions ---
        async function updateStats() {
            try {
                const req = await fetch('/api/v1/telemetry');
                const d = await req.json();
                
                document.getElementById('cpu').innerText = d.cpu;
                document.getElementById('downloads').innerText = d.downloads;
                document.getElementById('uploads').innerText = d.uploads;
                
                // Update Keys
                const keysDiv = document.getElementById('keys-list');
                keysDiv.innerHTML = d.api_keys.map(k => `
                    <div class="key-item">
                        <span>${k}</span>
                        <span class="key-copy" onclick="deleteKey('${k}')">ðŸ—‘</span>
                    </div>`).join('');

                const btn = document.getElementById('toggle-btn');
                if (d.status.includes("HALTED")) {
                    document.getElementById('status-text').innerText = "SUSPENDED";
                    document.getElementById('status-text').style.color = "var(--danger)";
                    document.getElementById('status-dot').style.background = "var(--danger)";
                    btn.innerText = "Resume Service"; btn.className = "btn-green";
                } else {
                    document.getElementById('status-text').innerText = "ACTIVE";
                    document.getElementById('status-text').style.color = "var(--success)";
                    document.getElementById('status-dot').style.background = "var(--success)";
                    btn.innerText = "Suspend Service"; btn.className = "btn-red";
                }
            } catch(e) {}
        }

        async function runSearch() {
            const q = document.getElementById('query').value;
            if(!q) return;
            document.getElementById('search-btn').innerText = "...";
            const res = await fetch(`/search?q=${encodeURIComponent(q)}`);
            const data = await res.json();
            document.getElementById('search-btn').innerText = "Search";
            
            const con = document.getElementById('results');
            con.innerHTML = "";
            data.results.forEach(item => {
                con.innerHTML += `
                <div class="result-row">
                    <img src="${item.thumb}" class="result-img">
                    <div class="result-meta">
                        <h4>${item.title.substring(0, 45)}</h4>
                        <span>${item.duration} â€¢ ${item.uploader}</span>
                    </div>
                    <div>
                        <span class="tag tag-aud" onclick="playMedia('${item.id}', 'audio')">PLAY ðŸŽµ</span>
                        <span class="tag tag-vid" onclick="playMedia('${item.id}', 'video')">WATCH ðŸ“º</span>
                    </div>
                </div>`;
            });
        }

        async function playMedia(id, type) {
            const modal = document.getElementById('player-modal');
            const container = document.getElementById('player-container');
            const title = document.getElementById('player-title');
            
            modal.style.display = 'block';
            title.innerText = "Fetching Stream...";
            container.innerHTML = `<div style="color:#888; text-align:center;">Buffering...</div>`;

            const res = await fetch(`/${type == 'audio' ? 'song' : 'video'}/${id}`);
            const data = await res.json();
            
            if(data.status == 'done') {
                title.innerText = data.title;
                if(type == 'audio') {
                    container.innerHTML = `<audio controls autoplay src="${data.link}"></audio>`;
                } else {
                    container.innerHTML = `<video controls autoplay src="${data.link}" style="max-height:200px;"></video>`;
                }
            } else {
                title.innerText = "Error Fetching Media";
            }
        }

        async function handleUpload(input) {
            const file = input.files[0];
            if(!file) return;
            
            document.getElementById('upload-text').innerText = "Uploading...";
            const fd = new FormData();
            fd.append('file', file);
            
            const req = await fetch('/upload', { method: 'POST', body: fd });
            const res = await req.json();
            
            if(res.status == "ok") {
                document.getElementById('upload-text').innerText = "Click to Upload Files";
                document.getElementById('upload-result').innerHTML = `Uploaded: <a href="${res.url}" target="_blank" style="color:var(--primary)">${res.url}</a>`;
            }
        }

        async function createKey() { await fetch('/api/v1/keys/create', {method:'POST'}); updateStats(); }
        async function deleteKey(k) { const fd = new FormData(); fd.append('key', k); await fetch('/api/v1/keys/delete', {method:'POST', body:fd}); updateStats(); }
        async function toggleSystem() { await fetch('/api/v1/admin/toggle', {method:'POST'}); updateStats(); }
        async function setSpeed() { const fd = new FormData(); fd.append('speed', document.getElementById('speed').value); await fetch('/api/v1/admin/throttle', {method:'POST', body:fd}); }

        setInterval(updateStats, 2000);
        updateStats();
    </script>
</body>
</html>
